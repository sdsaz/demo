<!-- if user dont have enough permission then display message -->
<div class="flexlayout" *ngIf="!hasPermission">
    <div class="form_wrapper">
        <div id="no-access-form">
            <div class="top">
                <img src="assets/images/default/NoAccessImage.png" class="mb-3" alt="">
                <div class="subtitle m-0">
                    {{'CASES.DETAIL.MESSAGE_CASES_NOT_ACCESS' | translate | configuredEntityName}}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- If id is not exists then display message -->
<div class="flexlayout" *ngIf="!casesDetailForm && !isInitialLoading && hasPermission">
    <div class="form_wrapper">
        <div id="no-access-form">
            <div class="top">
                <img src="assets/images/default/NoAccessImage.png" class="mb-3" alt="">
                <div class="subtitle mt-0">
                    {{'CASES.DETAIL.MESSAGE_CASES_NOT_EXISTS' | translate}}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-containted detail-cases" *ngIf="casesDetailForm && hasPermission && isLoaded">

    <!-- Header Start-->
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 mb-10px">
                <div class="detail-header h-100">
                    <div class="page-content card border-0 mb-0 h-100">
                        <div class="card-body p-card">
                            <div class="row align-items-start h-100">
                                <div class="col-xl col-lg-7 col-md-12 mb-3 mb-lg-0 mb-sm-4 d-flex align-self-start order-top-mobile">
                                    <div class="float-left text-center">
                                        <div id="entity-icon" class="entity-icon">
                                            <i class="fas fa-file-invoice" aria-hidden="true"></i>
                                        </div>
                                    </div>
                                    <div class="stage-details float-start">
                                        <p class="m-0">
                                            <span class="card-title mb-1">
                                                <label id="headingEntity">{{ 'CASES.DETAIL.CASE_NAME_LABEL' | translate | configuredEntityName }}</label>
                                                <div id="nameEntity" class="overflow-box">
                                                    <strong id="numberEntity"
                                                        class="pre-text">{{casesDetails.caseNumber}}</strong><strong *ngIf="casesDetails.caseNumber">:
                                                    </strong>
                                                    <strong id="nameOnlyEntity"
                                                        class="pre-text">{{caseName}}</strong>
                                                </div>
                                                <label *ngIf="casesDetails.parentID != null" id="headingEntityParent"
                                                    class="mt-2">{{ 'CASES.DETAIL.PARENT_WORK_TASK_NAME_LABEL' |
                                                    translate |
                                                    configuredEntityName }}</label>
                                                <div *ngIf="casesDetails.parentID != null" id="nameEntityParent"
                                                    class="overflow-box">
                                                    <a [routerLink]="'/cases/details/' + casesDetails.parentID"
                                                        class="dark-blue font-weight-bold no-underline cursor-pointer pre-text">{{casesDetails.parentCaseNumber}}: {{casesDetails.parentName}}</a>
                                                </div>
                                                <div>
                                                    <span id="entityRating" class="mt-2 h-21 mr-2 vertical-center">
                                                        <entity-review-display [entityTypeId]="entityTypeId" [entityId]="caseId" [isFromKanbanOrListView]="false"
                                                            [isEditPermission]="isEditCases && !casesDetails.isPaused">
                                                        </entity-review-display>
                                                    </span>
                                                    <span class="mt-2 h-21 badge badge-primary badge--status mr-2"
                                                        *ngIf="casesDetails.entityRecordTypeName"
                                                        id="badgeEntityRecordType">
                                                        {{casesDetails.entityRecordTypeName}}
                                                    </span>
                                                    <span id="badgePaused" *ngIf="casesDetails.isPaused"
                                                        class="mt-2 h-21 badge badge-danger badge--status">
                                                        {{ casesDetails.isPaused == true ? 'Paused' : '' }}
                                                    </span>
                                                </div>
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <div *ngIf="isEntityWorkflow && isListViewLayout && hiddenFieldStatus"
                                    class="col-header col-xl col-lg-3 col-md-4 col-sm-4 mb-1 mb-sm-3 mb-lg-3 mb-xl-0 pt-sm-3 pt-xl-0">
                                    <div class="row">
                                        <div class="col-sm-12 col-header-label">
                                            <label>{{
                                                'CASES.DETAIL.STATUS' | translate }}</label>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p class="m-0"><strong id="statusOrder">{{selectedStage?.name}}</strong></p>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="col-xxl col-xl col-lg-3 col-md-4 col-sm-4 mb-sm-3 mb-lg-3 mb-xl-0 mb-1 pt-sm-3 pt-xl-0 header-value col-header w-195px min-w-xxl-2" *ngIf="hiddenFieldCreated ||  hiddenFieldUpdated">
                                    <div class="row mb-1 mb-sm-2" *ngIf="hiddenFieldCreated">
                                        <div class="col-sm-12 col-header-label col-created-label">
                                            <label>{{ 'CASES.DETAIL.CREATED_LABEL' | translate }}</label>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p class="m-0" id="lblCreatedDate">
                                                {{casesDetails.created | date:'medium' }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="row mb-1 mb-sm-2 col-header" *ngIf="hiddenFieldUpdated">
                                        <div class="col-sm-12 col-header-label col-created-label">
                                            <label>{{ 'CASES.DETAIL.UPDATED_LABEL' | translate }}</label>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p class="m-0">
                                                {{casesDetails.modified | date:'medium' }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="isShowRelatedTo && hiddenFieldRelatedTo" class="col-xxl col-xl col-lg-3 col-md-4 col-sm-4 mb-sm-3 mb-lg-3 mb-xl-0 mb-1 pt-sm-3 pt-xl-0 header-value col-header order-top-mobile">
                                    <div class="row">
                                        <div class="col-auto px-0">
                                            <i [class]="relatedToIcon" class="font-26 dark-grey ml-2" aria-hidden="true" [ngbTooltip] = "relatedToIconToolTip" container="body" placement="top auto"></i>
                                        </div>
                                        <div class="col pl-2">
                                            <div class="">
                                                <label class="fs13px">{{relatedToNameForHeader}}</label>
                                            </div>
                                            <div class="">
                                                <p class="m-0">
                                                    <a [routerLink]="'/' + this._commonHelper.getRouteNameByEntityTypeId(cases?.entityTypeID).toLowerCase() + '/details/' + casesDetails.entityID"
                                                        class="dark-blue font-weight-bold no-underline cursor-pointer pre-text">{{casesDetails.entityName}}</a>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="col-xxl col-xl col-lg-3 col-md-4 col-sm-4 mb-sm-3 mb-lg-3 mb-xl-0 mb-1 pt-sm-3 pt-xl-0 header-value col-header min-w-xxl-2" *ngIf="hiddenFieldEstimatedMins || hiddenFieldEstimatedPoints">
                                    <div class="row mb-1 mb-sm-2" *ngIf="hiddenFieldEstimatedMins">
                                        <div class="col-sm-12 col-header-label">
                                            <label>{{ 'CASES.DETAIL.ESTIMATION_TIME' | translate }}</label>
                                            <i class="fas fa-info-circle dark-grey ml-1 info-tooltip"
                                                tooltipClass="custom-tooltip-class"
                                                [ngbTooltip]="('CASES.DETAIL.TOLLTIP_DURATION' | translate).replace('[[hoursInDay]]',hoursInDay)"
                                                placement="top top-left" container="body" aria-hidden="true"></i>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p-skeleton
                                                *ngIf="(!estimatedMins && estimatedMins != 0); else showEstimatedMins"
                                                width="8rem" styleClass="mb-2"></p-skeleton>
                                            <ng-template #showEstimatedMins>
                                                <p class="m-0">
                                                    {{ estimatedMins }}
                                                </p>
                                            </ng-template>
                                        </div>
                                    </div>
                                    <div class="row mb-1 mb-sm-2 col-header" *ngIf="hiddenFieldEstimatedPoints">
                                        <div class="col-sm-12 col-header-label">
                                            <label>{{ 'CASES.DETAIL.ESTIMATION_POINTS' | translate }}</label>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p-skeleton
                                                *ngIf="(!estimatedPoints && estimatedPoints != 0); else showEstimatedPoints"
                                                width="8rem" styleClass="mb-2"></p-skeleton>
                                            <ng-template #showEstimatedPoints>
                                                <p class="m-0">
                                                    {{ estimatedPoints != null ? estimatedPoints : 0}}
                                                </p>
                                            </ng-template>
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="isEntityWorkflow && (hiddenFieldElapsedTime ||  hiddenFieldEffectiveTime  || hiddenFieldPauseTime)"
                                    class="col-xxl col-xl col-lg-3 col-md-4 col-sm-4 mb-sm-3 mb-lg-3 mb-xl-0 mb-1 pt-sm-3 pt-xl-0 header-value col-header w-155px">
                                    <div class="row mb-1 mb-sm-2" *ngIf="hiddenFieldElapsedTime">
                                        <div class="col-sm-12 col-header-label">
                                            <label>{{ 'CASES.DETAIL.TOTAL_SPENT_TIME' | translate }}</label>
                                            <i class="fas fa-info-circle dark-grey ml-1 info-tooltip"
                                                tooltipClass="custom-tooltip-class"
                                                [ngbTooltip]="('CASES.DETAIL.TOLLTIP_DURATION' | translate).replace('[[hoursInDay]]',hoursInDay)"
                                                placement="top top-left" container="body" aria-hidden="true"></i>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p-skeleton *ngIf="!totalSpentTime; else showTotalSpentTime"
                                                width="8rem"></p-skeleton>
                                            <ng-template #showTotalSpentTime>
                                                <p class="m-0">
                                                    {{ totalSpentTime }}
                                                </p>
                                            </ng-template>

                                        </div>
                                    </div>
                                    <div class="row mb-1 mb-sm-2 col-header" *ngIf="hiddenFieldEffectiveTime">
                                        <div class="col-sm-12 col-header-label">
                                            <label>{{ 'CASES.DETAIL.TOTAL_EFFECTIVE_TIME' | translate }}</label>
                                            <i class="fas fa-info-circle dark-grey ml-1 info-tooltip"
                                                tooltipClass="custom-tooltip-class"
                                                [ngbTooltip]="('CASES.DETAIL.TOLLTIP_DURATION' | translate).replace('[[hoursInDay]]',hoursInDay)"
                                                placement="top top-left" container="body" aria-hidden="true"></i>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p-skeleton *ngIf="!totalEffectiveTime; else showTotalEffectiveTime"
                                                width="8rem"></p-skeleton>
                                            <ng-template #showTotalEffectiveTime>
                                                <p class="m-0">
                                                    {{ totalEffectiveTime }}
                                                </p>
                                            </ng-template>
                                        </div>
                                    </div>
                                    <div class="row mb-1 mb-sm-2 col-header" *ngIf="hiddenFieldPauseTime">
                                        <div class="col-sm-12 col-header-label">
                                            <label>{{ 'CASES.DETAIL.TOTAL_PAUSE_TIME' | translate }}</label>
                                            <i class="fas fa-info-circle dark-grey ml-1 info-tooltip"
                                                tooltipClass="custom-tooltip-class"
                                                [ngbTooltip]="('CASES.DETAIL.TOLLTIP_DURATION' | translate).replace('[[hoursInDay]]',hoursInDay)"
                                                placement="top top-left" container="body" aria-hidden="true"></i>
                                        </div>
                                        <div class="col-sm-12 col">
                                            <p-skeleton *ngIf="!totalPauseTime; else showTotalPauseTime"
                                                width="8rem"></p-skeleton>
                                            <ng-template #showTotalPauseTime>
                                                <p class="m-0" id="lblTotalPauseTime">
                                                    {{ totalPauseTime }}
                                                </p>
                                            </ng-template>
                                        </div>
                                    </div>
                                </div>
                                <div class="back-arrow col-lg">
                                    <div class="row">
                                    <div class="col-12">
                                        <button id="btn-back" class='btn btn-secondary mb-12px' type='button' (click)="onBack()">
                                            {{ 'CASES.DETAIL.BACK_BUTTON' | translate }}
                                        </button>
                                    </div>
                                    <div class="col-12">
                                        <div *ngIf="!casesDetails?.isPaused && (isEditCases || isDeleteCase)"class="dropdown">
                                            <button class="btn btn-primary dropdown-toggle btn-action" type="button" id="dropdownActionMenu"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                                {{ 'CASES.DETAIL.BUTTON_ACTION' | translate }}
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="dropdownActionMenu">
                                                <a *ngIf="isEditCases && isAllowToReopen && (isCompleted || isClosed)" id="link-stage-reopen" (click)="onReopenStage()" class="dropdown-item menu--item">
                                                    <i class="fa-regular fa-folder-open me-1"></i>
                                                    {{ 'CASES.DETAIL.ACTION_TITLE_STAGE_REOPEN' | translate }}
                                                </a>
                                                <a *ngIf="isDeleteCase && !isCompleted && !isClosed"  id="link-delete" (click)="onDeleteCaseClick(cases.id)"
                                                    class="dropdown-item menu--item">
                                                    <i class="far fa-trash-alt me-1" aria-hidden="true"></i>
                                                    {{'CASES.DETAIL.ACTION_TITLE_DELETE' | translate }}
                                                </a>
                                            </div>                                           
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <div class="col-xl-12 col-lg-12 align-self-end align-tags top-margin-tags">
                                    <div class="vertical-bottom flex-nowrap justify-content-between">
                                        <entity-tags-view [refreshEntityTag]="refreshEntityTag" [entityId]="entityId"
                                            [entityTypeId]="entityTypeId" [entityRecordTypeId]="entityRecordTypeId">
                                        </entity-tags-view>
                                
                                        <div class="pt-3 pl-3 pe-2 d-flex bookmark-icon">
                                            <ngx-bookmark [entityTypeId]="entityTypeId" [entityId]="entityId" [isEditPermission]="isEditCases && !(casesDetails.isPaused ?? false)" 
                                                class="font-18 me-3" [isFromKanbanOrListView]="false">
                                            </ngx-bookmark>
                                            <i *ngIf="casesDetails.isHandRaised" class="clr-remove-raise-hand fas fa-hand-paper font-18 me-3 cursor-pointer"
                                                (click)="onCaseRaiseHandChanged(casesDetails, false)" aria-hidden="true" id="removeRaiseHandButton"
                                                tooltipClass="tooltip-backward-small" [ngbTooltip]="'CASES.LABEL_HAND_UNRAISED'| translate" container="body">
                                            </i>
                                            <i *ngIf="!casesDetails.isHandRaised" class="clr-raise-hand far fa-hand-paper font-18 me-3 cursor-pointer"
                                                aria-hidden="true" id="raiseHandButton" (click)="onCaseRaiseHandChanged(casesDetails, true)"
                                                tooltipClass="tooltip-backward-small" [ngbTooltip]="'CASES.LABEL_HAND_RAISED'| translate" container="body">
                                            </i>
                                            <div *ngIf="casesDetails.isShowPauseOrResume && !isCompleted && !isClosed">
                                                <i *ngIf="casesDetails.isPaused && (this.loggedInUser.userId == casesDetails.assignedTo || isResumeRecord)"
                                                  class="far fa-play-circle font-18 dark-grey cursor-pointer" tooltipClass="tooltip-backward-small"
                                                  [ngbTooltip]="'CASES.DETAIL.TOOLTIP_RESUME'| translate" id="resumeButton" container="body"
                                                  (click)="onCaseStagePauseChanged(casesDetails, false)"></i>
                                                <i *ngIf="!isEditCases && casesDetails.isPaused && (this.loggedInUser.userId != casesDetails.assignedTo && !isResumeRecord)"
                                                  class="far fa-play-circle font-18 dark-grey cursor-pointer" tooltipClass="tooltip-backward-small"
                                                  [ngbTooltip]="'CASES.DETAIL.MESSAGE_RESUME_NOT_ACCESS'| translate" id="resumeButtonNotAccess"
                                                  container="body"></i>
                                                <i *ngIf="isEditCases && !casesDetails.isPaused && (this.loggedInUser.userId == casesDetails.assignedTo || isResumeRecord)"
                                                  class="far fa-pause-circle font-18 dark-grey cursor-pointer" tooltipClass="tooltip-backward-small"
                                                  [ngbTooltip]="'CASES.DETAIL.TOOLTIP_PAUSE'| translate" id="pauseButton" container="body"
                                                  (click)="onCaseStagePauseChanged(casesDetails, true)"></i>
                                              </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Header End-->

    <!-- Body Start-->
    <div *ngIf="isEntityWorkflow && !isListViewLayout" class="page-content container-fluid stage-process">
        <!-- Stages Buttons List Start -->
        <div class="con_scroll d-none d-lg-block d-md-block d-sm-none d-xs-none">
            <div class="btn-group btn-group-toggle arrow-steps mb-10px" data-toggle="buttons" #menuContent>
                <button type="button" class="btn btn-secondary btn--arrow" *ngFor="let stage of casesStages"
                    id="btnStatusChange" placement="top bottom"
                    [ngbTooltip]="stage.name" container="body" triggers="hover" tooltipClass="tooltip-backward-small"
                    [disabled]="!isEditCases || casesDetails.isPaused || isCompleted || isClosed || !isWorkflowPermission"
                    class="{{ 'btn btn-secondary btn--arrow ' + (stage | stageCss: currentStage) }}"
                    (click)="onMarkStageAsComplete(stage.id)">
                    <input type="radio" [name]="stage.name" autocomplete="off">
                    <span class="btn_name">{{ stage.name }}</span>
                </button>
            </div>
        </div>
        <div class="d-lg-none d-md-none d-sm-block d-xs-block py-2">
            <label>{{ 'CASES.DETAIL.STAGE_TITLE' | translate }}</label>
            <p-dropdown id="drp-StatusChange" class="form-control mb-2"
                [disabled]="!isEditCases || casesDetails.isPaused || isCompleted || isClosed || !isWorkflowPermission"
                [options]="casesStages" [(ngModel)]="selectedStage"
                (onChange)="onMarkStageAsComplete($event.value.id)">
                <ng-template let-stage pTemplate="selectedItem">
                    <div>{{stage.name}}</div>
                </ng-template>
                <ng-template let-stage pTemplate="item">
                    <div>{{stage.name}}</div>
                </ng-template>
            </p-dropdown>
        </div>
        <!-- Stages Buttons List End -->
    </div>

    <!-- Body Start-->
    <div class="page-content container-fluid pr-0">
        <div class="row h---100vh w-100">
            <div class="col col-xl-8 col-lg-12 mb-xl-0 mb-2 pr-0 details-box">
                <!-- nav Tab Menu Start -->
                <div class="navTabs card-bottom-border border-0 p-card">
                    <div class="row width--100 border-bottom m-0 first-tabs">
                        <!-- Tab Section here -->
                        <ng-container>
                            <ngx-globle-nav-tab [navTabs]="navTabs" [isNativeTab]="isNativeTab"
                                (setTab)="checkTabCall($event,1)" class="col tabs-mobile p-0"
                                (closeTab)="closeNavTab($event)"
                                [ngClass]="{'edit-icon-section': isReadOnly && !(['navWorkTasks','navContacts', 'navAttachment', 'navProducts', 'navHistory', 'additionalTabs'] | showHidePencilButton: activeTab)}"></ngx-globle-nav-tab>
                        </ng-container>
                        <div class="col-auto edit-form-icon px-0">
                            <div *ngIf="isEditCases && !casesDetails.isPaused && !isCompleted && !isClosed">
                                <i class="fas fa-pencil-alt pencil-icon fa-lg clr-blue float-right cursor-pointer"
                                    (click)="showHideDetailTab('EDIT')" id="btnEditTabDetail"
                                    *ngIf="isReadOnly && !(['navWorkTasks','navHistory','additionalTabs'] | showHidePencilButton: activeTab)"
                                    aria-hidden="true"></i>
                            </div>
                            <!-- Global save and cancel start -->
                            <div *ngIf="!isReadOnly && !(['navWorkTasks','navHistory', 'additionalTabs'] | showHidePencilButton: activeTab)"
                                class="form-update-icons">
                                <i id="btn-cancel"
                                    *ngIf="isEditCases && !casesDetails.isPaused && !isCompleted && !isClosed"
                                    class="fas fa-times fa-lg dark-grey float-right mr-3"
                                    (click)="showHideDetailTab('CANCEL')" aria-hidden="true"></i>
                                <i *ngIf="isEditCases && !casesDetails.isPaused && !isCompleted && !isClosed"
                                    id="btn-save" class="fas fa-check fa-lg clr-blue float-right"
                                    (click)="showHideDetailTab('SAVE')"
                                    aria-hidden="true"></i>
                            </div>
                            <!-- Global save and cancel end -->
                        </div>
                    </div>

                    <!-- Tab Content Start -->
                    <form [hidden]="isAdditionalTab" [formGroup]="casesDetailForm">
                        <div class="tab-content border-0 mt-0" id="casesDetailTabContent">
                            <!-- Details Start-->
                            <div class="tab-pane fade px-0 p-0" id="navDetails" role="tabpanel"
                                [ngClass]="selectedTab == 'navDetails' ? 'show active' : ''"
                                aria-labelledby="navDetails-tab" name="navDetails">

                                <!-- Basic Information Start-->
                                <div class="card border-0 m-0 pt-md-0 pt-3">
                                    <div class="card-header btn-card-edit py-0">
                                        <span class="vertical-center py-md-3 pt-0 pb-3 line-height-1">
                                            {{ 'CASES.DETAIL.DETAILS_TAB.BASIC_INFO_LABEL' | translate }}
                                        </span>
                                    </div>
                                    <div class='card-body'>
                                        <div class='row'>
                                            <div class='col-md-6 col-sm-6 form-group'>
                                                <label>
                                                    {{ 'CASES.DETAIL.DETAILS_TAB.NAME' | translate }}<span class="mandatory"></span>
                                                </label>
                                                <div *ngIf="isReadOnly" class="disable-text pre-text">{{
                                                    casesDetails.name != null && casesDetails.name != '' ?
                                                    casesDetails.name : '' }}</div>
                                                <input #casesTxtName *ngIf="!isReadOnly" id="txt-name" type="text"
                                                    class="form-control" formControlName="name"
                                                    [(ngModel)]="casesDetails.name" trimValue
                                                    [ngClass]="{ 'is-invalid': casesFrm.name.errors && (casesFrm.name.dirty || casesFrm.name.touched) }">
                                                <div *ngFor='let validation of cases_validation_messages.name'
                                                    class='invalid-feedback'>
                                                    <div id="errorNameIsRequired"
                                                        *ngIf='casesFrm.name.hasError(validation.type) && casesFrm.name.errors && (casesFrm.name.dirty || casesFrm.name.touched)'>
                                                        {{ validation.message | translate }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngIf="isEntityWorkflow && !isListViewLayout" class="col-sm-6 form-group">
                                                <!-- stage task start -->
                                                <label>{{ 'CASES.DETAIL.DETAILS_TAB.TASKS' | translate }}</label>
                                                <ng-template #disableTaskText>
                                                    <div class="disable-text">
                                                        {{ currentStageTask && currentStageTask.length > 0 ? (casesDetails.selectedStageTaskIds?.length ?? 0) + ' of ' +
                                                        currentStageTask.length + ' completed' :
                                                        ('CASES.DETAIL.DETAILS_TAB.NO_TASKS' | translate)
                                                        }}
                                                    </div>
                                                </ng-template>
                                                <div *ngIf="!isReadOnly && currentStageTask != null && isWorkflowPermission else disableTaskText"
                                                    class="input-group entity-dropdown custom-dropdown-muliselect">
                                                    <p-multiSelect [options]="currentStageTask" id="drp-stage-task"
                                                        class="entity-multiSelect" optionLabel="name"
                                                        formControlName="selectedStageTaskIds"
                                                        [(ngModel)]="casesDetails.selectedStageTaskIds"
                                                        [maxSelectedLabels]="500" [showToggleAll]="false"
                                                        [filter]="false" [showHeader]="false"
                                                        [displaySelectedLabel]='false'
                                                        [defaultLabel]="currentStageTask && currentStageTask.length > 0 ? (casesDetails.selectedStageTaskIds?.length ?? 0) + ' of ' + currentStageTask.length + ' completed' : ''">
                                                    </p-multiSelect>
                                                </div>
                                                <!-- stage task end -->
                                            </div>
                                            
                                            <div *ngIf="isShowRelatedTo" class="col-sm-6 form-group">
                                                <label>{{relatedToName}}</label>
                                                <div *ngIf="isReadOnly" class="disable-text pre-text"><i [class]="relatedToIcon" class="font-13 me-1" aria-hidden="true" [ngbTooltip] = "relatedToIconToolTip" container="body" placement="top auto"></i>
                                                    {{ casesDetails.entityName != null && casesDetails.entityName !=
                                                        '' ? casesDetails.entityName : '' }}</div>
                                                <!-- Related To Loading Bar -->

                                                <ngx-related-to-control *ngIf="!isReadOnly"
                                                    formControlName="entityID"
                                                    [isReadOnly]="casesDetails.entityTypeID != null ? true : false" 
                                                    [SelectedEntityTypeId]="SelectedEntityTypeId" 
                                                    [entityTypeId]="entityTypeId" 
                                                    [SelectedEntityId]="SelectedEntityId"
                                                    class="w-100 d-inline-block"
                                                    (valueChange)="onValueChange($event)"
                                                    (onChangeRelatedTo)="relatedToOnChange($event)">
                                                </ngx-related-to-control>

                                            </div>
                                            <div class='col-md-6 col-sm-6 form-group'>
                                                <label>
                                                    {{ 'CASES.DETAIL.DETAILS_TAB.ESTIMATION_TIME' | translate }}
                                                    <span class="mandatory"></span>
                                                    <i class="fas fa-info-circle dark-grey ml-1 info-tooltip"
                                                        tooltipClass="custom-tooltip-class"
                                                        [ngbTooltip]="estimatedMinsToolTip" placement="top bottom"
                                                        container="body" aria-hidden="true"></i>
                                                    <ng-template #estimatedMinsToolTip>
                                                        <div class="d-flex flex-column" style="text-align:left;">
                                                            {{
                                                            'CASES.DETAIL.DETAILS_TAB.ESTIMATION_TIME_TOOLTIP_HEADER'
                                                            | translate }}<br />
                                                            {{
                                                            'CASES.DETAIL.DETAILS_TAB.ESTIMATION_TIME_TOOLTIP_LINE1'
                                                            | translate }}<br />
                                                            {{
                                                            'CASES.DETAIL.DETAILS_TAB.ESTIMATION_TIME_TOOLTIP_LINE2'
                                                            | translate }}<br />
                                                            {{
                                                            'CASES.DETAIL.DETAILS_TAB.ESTIMATION_TIME_TOOLTIP_LINE3'
                                                            | translate }}<br />
                                                            {{
                                                            'CASES.DETAIL.DETAILS_TAB.ESTIMATION_TIME_TOOLTIP_LINE4'
                                                            | translate }}<br />
                                                        </div>
                                                    </ng-template>
                                                </label>
                                                <div *ngIf="isReadOnly" class="disable-text pre-text">{{ estimatedMins
                                                    }}</div>

                                                <input *ngIf="!isReadOnly" id="txt-estimationTime" type="text"
                                                    class="form-control" formControlName="estimatedMins"
                                                    [(ngModel)]="casesDetails.estimatedMins" trimValue
                                                    [ngClass]="{ 'is-invalid': casesFrm.estimatedMins.errors && (casesFrm.estimatedMins.dirty || casesFrm.estimatedMins.touched) }">
                                                <div *ngFor='let validation of cases_validation_messages.estimatedMins'
                                                    class='invalid-feedback'>
                                                    <div id="errorEstimatedMins"
                                                        *ngIf='casesFrm.estimatedMins.hasError(validation.type) && casesFrm.estimatedMins.errors && (casesFrm.estimatedMins.dirty || casesFrm.estimatedMins.touched)'>
                                                        {{ validation.message | translate }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class='col-md-6 col-sm-6 form-group'>
                                                <label>
                                                    {{ 'CASES.DETAIL.DETAILS_TAB.ESTIMATION_POINTS' | translate }}
                                                    <span class="mandatory"></span>
                                                </label>
                                                <div *ngIf="isReadOnly" class="disable-text pre-text">{{ estimatedPoints
                                                    }}</div>
                                                <input *ngIf="!isReadOnly" id="txt-estimationPoints" type="number"
                                                    class="form-control" (keypress)="numberInputHandler($event)" min="0"
                                                    formControlName="estimatedPoints"
                                                    [(ngModel)]="casesDetails.estimatedPoints"
                                                    [ngClass]="{ 'is-invalid': casesFrm.estimatedPoints.errors && (casesFrm.estimatedPoints.dirty || casesFrm.estimatedPoints.touched) }">
                                                <div *ngFor='let validation of cases_validation_messages.estimatedPoints'
                                                    class='invalid-feedback'>
                                                    <div id="errorestimatedPoints"
                                                        *ngIf='casesFrm.estimatedPoints.hasError(validation.type) && casesFrm.estimatedPoints.errors && (casesFrm.estimatedPoints.dirty || casesFrm.estimatedPoints.touched)'>
                                                        {{ validation.message | translate }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div *ngIf="isEntityWorkflow && !(entityHiddenFieldSettings | isEntityFieldHidden: entityTypeId : sectionCodes.DetailSection : fieldNames?.AssignedTo)" class='col-sm-6 form-group'>
                                                <label>{{ 'CASES.DETAIL.DETAILS_TAB.ASSIGNED_TO' | translate
                                                    }}</label>
                                                <ng-container
                                                    *ngIf="((isReadOnly || currentStage?.isCompleted || currentStage?.isClosed) || !isWorkflowPermission || !isAssignCase); else TemplateDrpAssignedTo">
                                                    <div class="disable-text pre-text">{{ casesDetails.assignedToName
                                                        != null && casesDetails.assignedToName != '' ?
                                                        casesDetails.assignedToName : '' }}</div>
                                                </ng-container>
                                            
                                                <ng-template #TemplateDrpAssignedTo>
                                            
                                                    <!-- Assigned To Loading Bar -->
                                                    <ngx-control-level-loading-bar *ngIf="showAssignedToLoader"></ngx-control-level-loading-bar>
                                            
                                                    <p-dropdown id="drp-assignedToIDs"
                                                        [placeholder]="('CASES.DETAIL.DETAILS_TAB.FILTER_PLACEHOLDER_ASSIGNED_TO' | translate)" class="form-control"
                                                        [options]="assignedToUsers" formControlName="assignedTo" [(ngModel)]="casesDetails.assignedTo"
                                                        (onFilter)="assignedToOnFilter($event)" (onChange)="assignedToOnChange($event)" [filter]="true"
                                                        [resetFilterOnHide]="false">
                                                    </p-dropdown>
                                                </ng-template>
                                            </div>
                                            <div *ngIf="isEntityWorkflow && !(entityHiddenFieldSettings | isEntityFieldHidden: entityTypeId : sectionCodes.DetailSection : fieldNames?.VerifiedBy)" class='col-sm-6 form-group'>
                                                <label>{{ 'CASES.DETAIL.DETAILS_TAB.VERIFIED_BY' | translate
                                                    }}</label>
                                            
                                                <ng-container *ngIf="isReadOnly || !isWorkflowPermission || !isAssignCase; else TemplateDrpVerifiedBy">
                                                    <div class="disable-text pre-text">{{ casesDetails.verifiedByName !=
                                                        null &&
                                                        casesDetails.verifiedByName != '' ?
                                                        casesDetails.verifiedByName : '' }}</div>
                                                </ng-container>
                                            
                                                <ng-template #TemplateDrpVerifiedBy>
                                                    <!-- Verified By Loading Bar -->
                                                    <ngx-control-level-loading-bar *ngIf="showVerifiedByLoader"></ngx-control-level-loading-bar>
                                                
                                                    <p-dropdown id="drp-verifiedByIDs"
                                                        [placeholder]="('CASES.DETAIL.DETAILS_TAB.FILTER_PLACEHOLDER_VERIFIED_BY' | translate)" class="form-control"
                                                        [options]="verifiedByUsers" formControlName="verifiedBy" [(ngModel)]="casesDetails.verifiedBy"
                                                        (onFilter)="verifiedByOnFilter($event)" (onChange)="verifiedByOnChange($event)" [filter]="true"
                                                        [resetFilterOnHide]="false">
                                                    </p-dropdown>
                                                </ng-template>
                                            </div>
                                            <div class='col-sm-6 form-group'>
                                                <label>{{ 'CASES.DETAIL.DETAILS_TAB.DUE_DATE' | translate }}</label>
                                                <div *ngIf="isReadOnly" class="disable-text">
                                                    {{
                                                    casesDetails.dueDate != null && casesDetails.dueDate != '' ?
                                                    (casesDetails.dueDate | dateFormatPipe:
                                                    _commonHelper.globalDateFormate) : ''
                                                    }}
                                                </div>
                                                <p-calendar *ngIf="!isReadOnly" id="dp-dueDates"
                                                    [dateFormat]="_commonHelper.globalDatePickerFormate"
                                                    [dateMask]="_commonHelper.globalDateMask" [readonlyInput]="false"
                                                    icon="fas fa-calendar-alt dark-grey" [showIcon]="true"
                                                    [monthNavigator]="true" [yearNavigator]="true"
                                                    [yearRange]="currentYearRange" [minDate]="getCurrentDate()"
                                                    [maxDate]="_commonHelper.globalMaxDate" formControlName="dueDate"
                                                    [selectOtherMonths]="true" [readonlyInput]="false"
                                                    [(ngModel)]="casesDetails.dueDate" [showTime]="false"
                                                    [placeholder]="_commonHelper.globalDatePlaceholder"
                                                    class="time-calendar"></p-calendar>
                                            </div>
                                            <div class='col-md-6 col-sm-6 form-group' *ngIf="isEntityWorkflow && isListViewLayout">
                                                <label>{{'CASES.DETAIL.DETAILS_TAB.STATUS' | translate}} <span class="mandatory"></span></label>
                                                <div class="disable-text" *ngIf="isReadOnly">
                                                    {{ (casesStages | displayValueFinder: {id:casesDetails.entityStageId})?.length
                                                    ?
                                                    (casesStages | displayValueFinder: {id:casesDetails.entityStageId})[0].name : ' ' }}
                                                </div>
                                                <p-dropdown *ngIf="!isReadOnly" id="drp-stageId" class="form-control" formControlName="entityStageId"
                                                    [filter]="true" [resetFilterOnHide]="false" [options]="casesStages"
                                                    placeholder="{{'CASES.DETAIL.DETAILS_TAB.STATUS_PLACEHOLDER' | translate}}" optionLabel="name"
                                                    optionValue="id" [(ngModel)]="casesDetails.entityStageId"
                                                    [ngClass]="{ 'is-invalid': submitted && casesFrm.entityStageId.errors }">
                                                </p-dropdown>
                                                <div *ngFor='let validation of cases_validation_messages.entityStageId' class='invalid-feedback'>
                                                    <div id="errorStageIsRequired" 
                                                    *ngIf='casesFrm.entityStageId.hasError(validation.type) && submitted && casesFrm.entityStageId.errors'>
                                                        {{ validation.message | translate }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class='col-md-6 col-sm-6 form-group'>
                                                <label>{{ 'CASES.DETAIL.DETAILS_TAB.PRIORITY' | translate }}</label>
                                                <div *ngIf="isReadOnly" class="disable-text">
                                                    {{ casesDetails.priorityName != null && casesDetails.priorityName != '' ? casesDetails.priorityName : '' }}
                                                </div>

                                                <!-- Priority Loading Bar -->
                                                <ngx-control-level-loading-bar
                                                    *ngIf="showPriorityLoader"></ngx-control-level-loading-bar>

                                                <p-dropdown *ngIf="!isReadOnly" id="drp-priorityIDs"
                                                    [placeholder]="('CASES.DETAIL.DETAILS_TAB.FILTER_PLACEHOLDER_PRIORITY' | translate)"
                                                    class="form-control" [options]="priorityList"
                                                    formControlName="priority" [(ngModel)]="casesDetails.priority">
                                                </p-dropdown>
                                            </div>
                                            <div class='col-md-6 col-sm-6 form-group'>
                                                <label>{{ 'CASES.DETAIL.DETAILS_TAB.SEVERITY' | translate }}</label>
                                                <div *ngIf="isReadOnly" class="disable-text">
                                                    {{ casesDetails.severityName != null && casesDetails.severityName != '' ? casesDetails.severityName : '' }}
                                                </div>

                                                <!-- Severity Loading Bar -->
                                                <ngx-control-level-loading-bar
                                                    *ngIf="showSeverityLoader"></ngx-control-level-loading-bar>

                                                <p-dropdown *ngIf="!isReadOnly" id="drp-severityIDs"
                                                    [placeholder]="('CASES.DETAIL.DETAILS_TAB.FILTER_PLACEHOLDER_SEVERITY' | translate)"
                                                    class="form-control" [options]="severityList"
                                                    formControlName="severity" [(ngModel)]="casesDetails.severity">
                                                </p-dropdown>
                                            </div>
                                            <div class='col-md-12 col-sm-12 form-group'>
                                                <label>{{ 'CASES.DETAIL.DETAILS_TAB.DESCRIPTION' | translate
                                                    }}</label>
                                                <div *ngIf="isReadOnly" class="disable-text h-100-box"
                                                    style="align-items: normal;">
                                                    <iframe width="100%" height="100%"
                                                        [srcdoc]="casesDetails.description | safehtml"
                                                        title="casesDetailsDescription"></iframe>
                                                </div>

                                                <editor apiKey="{{tinyMceApiKey}}" *ngIf="!isReadOnly"
                                                    [(ngModel)]="casesDetails.description"
                                                    formControlName="description" id="txt-description"
                                                    class="editor-description-iframe"
                                                    [ngClass]="{ 'is-invalid': casesFrm.description.errors && (casesFrm.description.dirty || casesFrm.description.touched) }"
                                                    [ngModelOptions]="{standalone: true}" [init]="{ height: 500 }">
                                                </editor>
                                                <div *ngFor='let validation of cases_validation_messages.description'
                                                    class='invalid-feedback'>
                                                    <div id="errorNameIsRequired"
                                                        *ngIf='casesFrm.description.hasError(validation.type) && casesFrm.description.errors && (casesFrm.description.dirty || casesFrm.description.touched)'>
                                                        {{ validation.message | translate }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Details End-->

                            <!-- Custom Start-->
                            <div class="tab-pane fade px-0 pt-0"
                                [ngClass]="selectedTab == ('nav' + tab.tabName | removeWhiteSpace) ? 'show active' : ''"
                                *ngFor="let tab of formDataJSON; let i = index"
                                id="{{ 'nav' + tab.tabName | removeWhiteSpace }}" name="navCustom" role="tabpanel"
                                aria-labelledby="navCustom-tab">
                                <!-- Section Start-->
                                <div class='card border-0 m-0 pt-md-0 pt-3'
                                    *ngFor="let section of tab.sections; let j = index">
                                    <div class="card-header btn-card-edit py-0">
                                        <span *ngIf="section.sectionName"
                                            class="vertical-center py-md-3 pt-0 pb-3 line-height-1">{{section.sectionName}}</span>
                                    </div>
                                    <div class='card-body'>
                                        <div class='row'>
                                            <ngx-custom-field [formGroup]="casesDetailForm" [section]="section"
                                                [controls]="section.controls"
                                                [customFieldJSONData]="casesDetails.customFieldJSONData"
                                                [isReadOnly]="isReadOnly" [submitted]="submitted"
                                                [currencySymbol]="currencySymbol"
                                                [refreshTabularDataSource]="refreshCustomFieldDatasource"
                                                [entityID]="entityId" [entityTypeID]="entityTypeId"
                                                [entityRecordTypeID]="entityRecordTypeId"></ngx-custom-field>
                                        </div>
                                    </div>
                                </div>
                                <!-- Section End-->
                            </div>
                            <!-- Custom End-->
                            
                            <!-- Work Tasks Start-->
                            <div class="tab-pane fade p-3 search-wrapper" id="navWorkTasks" role="tabpanel"
                                [ngClass]="selectedTab == 'navWorkTasks' ? 'show active' : ''" aria-labelledby="navWorkTasks-tab"
                                name="navWorkTasks">
                                <div class="mb-3 vertical-center justify-content-end dropdown-with-add" *ngIf="isEditCases && isAddWorkTask && !casesDetails.isPaused && !isCompleted && !isClosed">
                                    <button *ngIf="onceWorkTaskClicked" type="button" id="btn-add-workTask" class="btn btn-primary ml-3"
                                        (click)="addWorkTask()">
                                        <i *ngIf="workTaskSubTypeDetails?.iconClass" class="{{workTaskSubTypeDetails?.iconClass}} mr-1"
                                            aria-hidden="true"></i>
                                        {{('CASES.DETAIL.TAB_WORKTASKS.ADD_WORKTASK_PREFIX'| translate)+" "+workTaskSubTypeDetails?.name}}
                                    </button>
                                </div>
                                <div class="expandable-card">
                                    <ng-container *ngIf="onceWorkTaskClicked">
                                        <ngx-work-task-expandable-table [entityID]="caseId" [entityTypeID]="entityTypeId" [refresh]="refreshWorkTaskTab"
                                            [isEntityActive]="!casesDetails.isPaused && !isCompleted && !isClosed"></ngx-work-task-expandable-table>
                                    </ng-container>
                                </div>
                            </div>
                            <!-- Work Tasks End-->
 
                            <!-- Stage/Pause history Start-->
                            <div class="tab-pane fade" id="navHistory" role="tabpanel"
                                [ngClass]="selectedTab == 'navHistory' ? 'show active' : ''"
                                aria-labelledby="navHistory-tab" name="navHistory">
                                <ng-container *ngIf="onceStageHistoryClicked">
                                    <ngx-history-tab 
                                        [entityWorkflowId]="entityWorkflowId" 
                                        [privacyLevel]="casesDetails?.privacyLevel"
                                        [entityTypeId]="entityTypeId"
                                        [entityId]="caseId" [hoursInDay]="hoursInDay"
                                        [refreshStageHistory]="refreshStageHistory"
                                        [refreshActivityHistory]="refreshActivityHistory"
                                        [isListViewLayout]="isListViewLayout"
                                        [entityHiddenFieldSettings]="entityHiddenFieldSettings"></ngx-history-tab>
                                </ng-container>
                            </div>
                            <!-- Stage/Pause history End-->

                            <!-- Document Start-->
                            <div class="tab-pane fade p-3 search-wrapper" id="navDocuments" role="tabpanel"
                                [ngClass]="selectedTab == 'navDocuments' ? 'show active' : ''" aria-labelledby="navDocuments-tab"
                                name="navDocuments">
                                <ng-container *ngIf="onceDocumentClicked">
                                    <ngx-entity-documents [entityID]="entityId" class="entity-documents" [entityTypeID]="entityTypeId"
                                        [isDocumentDownloadPermission]="isDocumentDownloadPermission && !casesDetails.isPaused && !isCompleted && !isClosed"
                                        [isEditPermission]="isEditCases && !casesDetails.isPaused && !isCompleted && !isClosed"
                                        [refreshFromParent]="refreshActivityHistory" (refreshDocuments)="setRefreshDocument()"
                                        [privacyLevel]="casesDetails?.privacyLevel">
                                    </ngx-entity-documents>
                                </ng-container>
                            </div>
                            <!-- Document End-->

                        </div>
                    </form>
                    <!-- Tab Content END -->
                    <div *ngIf="isAdditionalTab">
                        <!-- Tab Additional here -->
                        <ng-container>
                            <ngx-globle-nav-tab [isNativeTab]="isNativeTab" [isAdditionalTab]="isAdditionalTab"
                                [navTabs]="navTabsMore" (setTab)="checkTabCall($event,0)" class="col-12 p-0"
                                (closeTab)="closeNavTab($event)"
                                [ngClass]="{'edit-icon-section': isReadOnly && !(['navWorkTasks','navContacts', 'navAttachment', 'navProducts', 'navHistory', 'additionalTabs'] | showHidePencilButton: activeTab)}"></ngx-globle-nav-tab>
                        </ng-container>
                    </div>
                    <!-- Tab Other Tabs Link -->
                </div>
            </div>
            <activity-section 
                [entityTypeId]="entityTypeId" 
                [privacyLevel]="casesDetails?.privacyLevel"
                [entityId]="entityId" 
                [isTagRequired]="true"
                [isEditPermission]="isEditCases"
                [isPaused]="casesDetails.isPaused"
                [isClosedStage]="isClosed"
                [isCompletedStage]="isCompleted"
                [isDocumentRequired]="true" 
                [refreshDocument]="refreshDocument"
                [refreshActivity]="refreshActivity"
                [entityRecordTypeId]="entityRecordTypeId"
                [isDocumentDownloadPermission]="isDocumentDownloadPermission && !casesDetails.isPaused && !isCompleted && !isClosed"
                (isTagListUpdated)="setRefreshEntityTag()" 
                (isActivityListUpdated)="setRefreshActivityHistory()"
                class="col-xl-4 col-md-12 common-box pr-0"
                [createdBy]="casesDetails?.createdBy">
            </activity-section>
        </div>
    </div>
    <!-- Body End-->
</div>

<!-- end Json Grid -->
